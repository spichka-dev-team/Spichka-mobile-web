name: Deploy Frontend to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest 

    steps:
     
      - name: üöÄ Notify Pipeline Start
        uses: appleboy/telegram-action@master
        with:
          to: -1002824319072
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message_thread_id: 11299
          format: markdown
          message: |
            üîÑ *–ü–∞–π–ø–ª–∞–π–Ω Deploy Frontend to Production –∑–∞–ø—É—â–µ–Ω*
            
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `${{ github.repository }}`
            üåø –í–µ—Ç–∫–∞: `${{ github.ref_name }}`
            üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: `${{ github.actor }}`
            üí¨ –ö–æ–º–º–∏—Ç: `${{ github.event.head_commit.message }}`
            üîó [–û—Ç–∫—Ä—ã—Ç—å –≤ CI/CD](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...
            üìé ID –∑–∞–¥–∞—á–∏: `${{ github.run_id }}`

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ node_modules
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: DNS & SSH reachability check
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dnsutils netcat-openbsd
          echo "DNS:"
          dig +short "${{ secrets.HOST }}" || true
          echo "Ping:"
          ping -c 3 "${{ secrets.HOST }}" || true
          echo "SSH port:"
          nc -vz "${{ secrets.HOST }}" 22 || true

      - name: Test SSH Connection
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "SSH connection successful!"
            whoami
            pwd
            ls -la
    
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/spichka/Spichka-mobile-web
            git pull origin main
            ./deploy.sh

      
      - name: üéâ Notify Success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: -1002824319072
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message_thread_id: 11299
          format: markdown
          message: |
            ‚úÖ *–ü–∞–π–ø–ª–∞–π–Ω Deploy Frontend to Production –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ*
            
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `${{ github.repository }}`
            üåø –í–µ—Ç–∫–∞: `${{ github.ref_name }}`
            üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: `${{ github.actor }}`
            üí¨ –ö–æ–º–º–∏—Ç: `${{ github.event.head_commit.message }}`
            üîó [–û—Ç–∫—Ä—ã—Ç—å –≤ CI/CD](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: `${{ job.status }}`
            üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç: Frontend —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ! üöÄ
            üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 3000

      - name: üí• Notify Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: -1002824319072
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message_thread_id: 11299
          format: markdown
          message: |
            ‚ùå *–ü–∞–π–ø–ª–∞–π–Ω Deploy Frontend to Production –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π*
            
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `${{ github.repository }}`
            üåø –í–µ—Ç–∫–∞: `${{ github.ref_name }}`
            üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: `${{ github.actor }}`
            üí¨ –ö–æ–º–º–∏—Ç: `${{ github.event.head_commit.message }}`
            üîó [–û—Ç–∫—Ä—ã—Ç—å –≤ CI/CD](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üìç –≠—Ç–∞–ø: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —à–∞–≥–∞
            üí• –û—à–∏–±–∫–∞: –ü–∞–π–ø–ª–∞–π–Ω –ø—Ä–µ—Ä–≤–∞–Ω –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ —ç—Ç–∞–ø–æ–≤
            
            –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
            ‚Ä¢ –û—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ –∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
            ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å Docker build
            ‚Ä¢ –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
            ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

    
      - name: ‚ö†Ô∏è Notify Cancellation
        if: cancelled()
        uses: appleboy/telegram-action@master
        with:
          to: -1002824319072
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message_thread_id: 11299
          format: markdown
          message: |
            ‚ö†Ô∏è *–ü–∞–π–ø–ª–∞–π–Ω Deploy Frontend to Production –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω*
            
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `${{ github.repository }}`
            üåø –í–µ—Ç–∫–∞: `${{ github.ref_name }}`
            üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: `${{ github.actor }}`
            üí¨ –ö–æ–º–º–∏—Ç: `${{ github.event.head_commit.message }}`
            üîó [–û—Ç–∫—Ä—ã—Ç—å –≤ CI/CD](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üõë –ü–∞–π–ø–ª–∞–π–Ω –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ç–∞–π–º-–∞—É—Ç—É
